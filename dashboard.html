<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f6fa; }
    header { background: #00274d; color: white; padding: 15px; text-align: center; }
    .sidebar { position: fixed; top: 0; left: 0; width: 220px; height: 100%; background: #1a1a2e; padding-top: 20px; color: white; }
    .sidebar h2 { text-align: center; margin-bottom: 30px; }
    .sidebar a { display: block; padding: 12px; color: white; text-decoration: none; margin: 5px 0; }
    .sidebar a:hover { background: #16213e; }
    .content { margin-left: 240px; padding: 20px; }
    .user-info { text-align: center; margin-bottom: 20px; }
    .user-info img { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 10px; object-fit: cover; }
    .balance { background: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .transactions, .settings { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Menu</h2>
    <a href="#" onclick="showSection('dashboard')">Dashboard</a>
    <a href="#" onclick="showSection('deposit')">Deposit</a>
    <a href="#" onclick="showSection('withdrawal')">Withdrawal</a>
    <a href="#" onclick="showSection('history')">History</a>
    <a href="#" onclick="showSection('settings')">Settings</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <!-- Main Content -->
  <div class="content">
    <div class="user-info">
      <img id="user-photo" src="https://via.placeholder.com/100" alt="User Photo">
      <h2 id="user-name"></h2>
      <p id="user-email"></p>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-section">
      <div class="balance">
        <h3>Account Balance</h3>
        <h2 id="user-balance">$0.00</h2>
      </div>
    </div>

    <!-- Deposit -->
    <div id="deposit-section" style="display:none;">
      <h3>Deposit Funds</h3>
      <p>Deposit form here...</p>
    </div>

    <!-- Withdrawal -->
    <div id="withdrawal-section" style="display:none;">
      <h3>Withdraw Funds</h3>
      <p>Withdrawal form here...</p>
    </div>

    <!-- History -->
    <div id="history-section" style="display:none;">
      <div class="transactions">
        <h3>Transaction History</h3>
        <table>
          <thead>
            <tr><th>Date</th><th>Type</th><th>Amount</th><th>Status</th></tr>
          </thead>
          <tbody id="transaction-history"></tbody>
        </table>
      </div>
    </div>

    <!-- Settings -->
    <div id="settings-section" style="display:none;">
      <h3>Update Profile</h3>
      <form id="settings-form">
        <label>Full Name:</label><br>
        <input type="text" id="set-name"><br><br>
        <label>Email:</label><br>
        <input type="email" id="set-email"><br><br>
        <label>Upload New Picture:</label><br>
        <input type="file" id="set-photo" accept="image/*"><br><br>
        <button type="submit">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfQGrLEYcNfmYid8XvigP5ZXJh1RNoipM",
      authDomain: "capital-one-16a95.firebaseapp.com",
      projectId: "capital-one-16a95",
      storageBucket: "capital-one-16a95.appspot.com",
      messagingSenderId: "1061937867911",
      appId: "1:1061937867911:web:347450d4e37ce73d0b5c22"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Check login state
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      // Get user data from Firestore
      const userDoc = await getDoc(doc(db, "registrations", user.uid));
      if (userDoc.exists()) {
        const data = userDoc.data();
        document.getElementById("user-photo").src = data.photoURL || "https://via.placeholder.com/100";
        document.getElementById("user-name").innerText = data.firstName + " " + data.lastName;
        document.getElementById("user-email").innerText = data.email;
        document.getElementById("user-balance").innerText = "$" + (data.balance || 0).toFixed(2);

        // Pre-fill settings
        document.getElementById("set-name").value = data.firstName + " " + data.lastName;
        document.getElementById("set-email").value = data.email;

        // Fake transactions
        let transactions = [
          {date:"2025-08-01", type:"Deposit", amount:1000, status:"Completed"},
          {date:"2025-08-10", type:"Withdrawal", amount:500, status:"Pending"},
          {date:"2025-08-15", type:"Deposit", amount:2000, status:"Completed"}
        ];
        let historyBody = document.getElementById("transaction-history");
        historyBody.innerHTML = "";
        transactions.forEach(tx => {
          historyBody.innerHTML += `<tr>
            <td>${tx.date}</td><td>${tx.type}</td><td>$${tx.amount}</td><td>${tx.status}</td>
          </tr>`;
        });
      }
    });

    // Show sections
    window.showSection = function(section) {
      document.querySelectorAll(".content > div").forEach(div => div.style.display = "none");
      document.getElementById(section + "-section").style.display = "block";
    }

    // Settings update
    document.getElementById("settings-form").addEventListener("submit", async function(e){
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      const name = document.getElementById("set-name").value;
      const email = document.getElementById("set-email").value;
      const file = document.getElementById("set-photo").files[0];
      let photoURL = "";

      if (file) {
        const storageRef = ref(storage, "profilePics/" + user.uid + "_" + file.name);
        await uploadBytes(storageRef, file);
        photoURL = await getDownloadURL(storageRef);
      }

      await updateDoc(doc(db, "registrations", user.uid), {
        email,
        photoURL: photoURL || undefined
      });

      alert("Profile updated successfully!");
      location.reload();
    });

    // Logout
    window.logout = async function() {
      await signOut(auth);
      window.location.href = "login.html";
    }
  </script>
</body>
</html>
