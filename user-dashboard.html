<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 0; }
    .header { background: #d40000; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .header h2 { margin: 0; display: flex; align-items: center; }
    .profile-pic { width: 40px; height: 40px; border-radius: 50%; margin-left: 10px; object-fit: cover; border: 2px solid white; }
    .container { padding: 20px; }
    .card, .history { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0px 0px 5px rgba(0,0,0,0.1); }
    button { padding: 10px 20px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; }
    .btn { background: #d40000; color: white; }
    .btn:hover { background: #a80000; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
    .tx-pic { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 350px; }
    .modal-content h3 { margin-top: 0; }
    .close { float: right; font-size: 20px; cursor: pointer; }
    input { width: 100%; padding: 10px; margin: 8px 0; border-radius: 5px; border: 1px solid #ccc; }

    /* Credit Card */
    .credit-card {
      background: linear-gradient(135deg, #b00000, #e60000);
      color: white;
      padding: 25px;
      border-radius: 15px;
      width: 350px;
      margin: 10px auto;
      font-family: "OCR A Std", monospace;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }
    .boa-logo { height: 40px; margin-bottom: 20px; }
    .cc-number { font-size: 22px; letter-spacing: 4px; margin: 20px 0; }
    .cc-info { display: flex; justify-content: space-between; margin: 15px 0; font-size: 14px; }
    .cc-info span { font-size: 10px; display: block; color: #ddd; }
    .cc-footer { display: flex; justify-content: space-between; align-items: center; }
    .card-holder { font-size: 14px; text-transform: uppercase; margin-top: 10px; }
    .cc-pic { width: 50px; height: 50px; border-radius: 50%; border: 2px solid white; }
    .network-logo { position: absolute; bottom: 15px; right: 20px; height: 30px; }
  </style>
</head>
<body>

<div class="header">
  <h2>Welcome, <span id="userName"></span> <img id="userPic" class="profile-pic" src=""></h2>
  <button onclick="logout()">Logout</button>
</div>

<div class="container">

  <!-- Balance -->
  <div class="card">
    <h3>Account Balance: <span id="balance"></span></h3>
    <p>Account Number: <span id="accountNumber"></span></p>
  </div>

  <!-- Credit Card -->
  <div class="card">
    <h3>Your Virtual Credit Card</h3>
    <div class="credit-card">
      <div class="cc-header">
        <img src="https://1000logos.net/wp-content/uploads/2017/06/Bank-of-America-Logo-2001.png" 
             class="boa-logo" alt="Bank of America Logo">
      </div>
      <div class="cc-number" id="ccNumber">**** **** **** 1234</div>
      <div class="cc-info">
        <div>
          <span>EXP</span>
          <div id="ccExpiry">12/28</div>
        </div>
        <div>
          <span>CVV</span>
          <div id="ccCVV">***</div>
        </div>
      </div>
      <div class="cc-footer">
        <div class="card-holder" id="ccName">John Doe</div>
        <img id="ccPic" class="cc-pic" src="https://via.placeholder.com/50">
      </div>
      <img id="networkLogo" class="network-logo" src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg">
    </div>
  </div>

  <!-- Actions -->
  <div class="card">
    <h3>Quick Actions</h3>
    <button class="btn" onclick="openModal('withdrawModal')">Withdraw</button>
    <button class="btn" onclick="openModal('transferModal')">International Transfer</button>
    <button class="btn" onclick="openModal('loanModal')">Request Loan</button>
  </div>

  <!-- History -->
  <div class="history">
    <h3>Transaction Requests</h3>
    <table>
      <thead>
        <tr>
          <th>Pic</th>
          <th>Date</th>
          <th>Type</th>
          <th>Details</th>
          <th>Amount</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>

</div>

<!-- Modals (withdraw, transfer, loan) unchanged -->
<div id="withdrawModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('withdrawModal')">&times;</span>
    <h3>Withdraw Funds</h3>
    <input type="number" id="withdrawAmount" placeholder="Enter amount">
    <button class="btn" onclick="submitWithdraw()">Submit Request</button>
  </div>
</div>
<div id="transferModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('transferModal')">&times;</span>
    <h3>International Transfer</h3>
    <input type="text" id="recipient" placeholder="Recipient Name">
    <input type="text" id="recipientAcc" placeholder="Recipient Account Number">
    <input type="number" id="transferAmount" placeholder="Enter amount">
    <button class="btn" onclick="submitTransfer()">Submit Request</button>
  </div>
</div>
<div id="loanModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('loanModal')">&times;</span>
    <h3>Request Loan</h3>
    <input type="number" id="loanAmount" placeholder="Enter loan amount">
    <button class="btn" onclick="submitLoan()">Submit Request</button>
  </div>
</div>

<script>
  let user = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!user) window.location.href = "login.html";

  const fmt = (n) => "$" + Number(n).toFixed(2);

  // Helper: generate card number (Luhn compliant)
  function generateCardNumber(type='visa') {
    let prefix = type === 'visa' ? '4' : '5';
    let number = prefix;
    while(number.length < 15) number += Math.floor(Math.random()*10);
    let sum = 0;
    for (let i=0;i<15;i++) {
      let digit = parseInt(number[i]);
      if (i%2===0) digit*=2;
      if(digit>9) digit-=9;
      sum+=digit;
    }
    let check = (10 - (sum % 10)) % 10;
    number += check;
    return number.match(/.{1,4}/g).join(' ');
  }

  function generateExpiry() {
    let month = String(Math.floor(Math.random()*12+1)).padStart(2,'0');
    let year = String(new Date().getFullYear() + Math.floor(Math.random()*5+1)).slice(-2);
    return `${month}/${year}`;
  }

  function generateCVV() { return String(Math.floor(Math.random()*900+100)); }

  // Ensure credit card
  if(!user.creditCard){
    let type = Math.random()<0.5?'visa':'mastercard';
    let number = generateCardNumber(type);
    user.creditCard = {
      number,
      expiry: generateExpiry(),
      cvv: generateCVV(),
      name: user.fullName,
      type
    };
    updateUser(user);
  }

  // Display info
  document.getElementById("userName").innerText = user.fullName;
  document.getElementById("userPic").src = user.picture || "https://via.placeholder.com/40";
  document.getElementById("balance").innerText = fmt(user.balance);
  document.getElementById("accountNumber").innerText = user.accountNumber;
  document.getElementById("ccName").innerText = user.creditCard.name;
  document.getElementById("ccNumber").innerText = user.creditCard.number;
  document.getElementById("ccExpiry").innerText = user.creditCard.expiry;
  document.getElementById("ccCVV").innerText = user.creditCard.cvv;
  document.getElementById("ccPic").src = user.picture || "https://via.placeholder.com/50";

  // Set network logo
  document.getElementById('networkLogo').src = user.creditCard.type==='visa' 
    ? 'https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg' 
    : 'https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg';

  function renderHistory() {
    const table = document.getElementById("historyTable");
    table.innerHTML = "";
    (user.requests || []).forEach(r => {
      let row = `<tr>
        <td><img class="tx-pic" src="${user.picture || 'https://via.placeholder.com/30'}"></td>
        <td>${r.date}</td>
        <td>${r.type}</td>
        <td>${r.details}</td>
        <td>${fmt(r.amount)}</td>
        <td>${r.status}</td>
      </tr>`;
      table.innerHTML += row;
    });
  }
  renderHistory();

  function addRequest(type, details, amount) {
    if (!user.requests) user.requests = [];
    user.requests.push({
      id: Date.now(),
      date: new Date().toLocaleString(),
      type, details, amount,
      status: "Pending"
    });
    updateUser(user);
    renderHistory();
    alert(type + " request submitted and pending admin approval.");
  }

  function submitWithdraw() {
    let amt = Number(document.getElementById("withdrawAmount").value);
    if (amt <= 0) { alert("Invalid amount"); return; }
    addRequest("Withdraw", "Cash withdrawal", amt);
    closeModal('withdrawModal');
  }

  function submitTransfer() {
    let amt = Number(document.getElementById("transferAmount").value);
    let rec = document.getElementById("recipient").value;
    let recAcc = document.getElementById("recipientAcc").value;
    if (!rec || !recAcc || amt <= 0) { alert("Invalid transfer"); return; }
    addRequest("Transfer", `To ${rec} (${recAcc})`, amt);
    closeModal('transferModal');
  }

  function submitLoan() {
    let amt = Number(document.getElementById("loanAmount").value);
    if (amt <= 0) { alert("Invalid loan"); return; }
    addRequest("Loan", "Loan request", amt);
    closeModal('loanModal');
  }

  function updateUser(u) {
    let users = JSON.parse(localStorage.getItem("users")) || [];
    let idx = users.findIndex(x => x.username === u.username);
    if (idx !== -1) users[idx] = u;
    localStorage.setItem("users", JSON.stringify(users));
    localStorage.setItem("loggedInUser", JSON.stringify(u));
  }

  function logout() {
    localStorage.removeItem("loggedInUser");
    window.location.href = "login.html";
  }

  function openModal(id) { document.getElementById(id).style.display = "flex"; }
  function closeModal(id) { document.getElementById(id).style.display = "none"; }
</script>

</body>
</html>
